# Videos API - Development Environment

Este documento descreve como configurar e usar o ambiente de desenvolvimento local com Docker, Redis para cache e mocks para as integra√ß√µes externas.

## üèóÔ∏è Arquitetura de Desenvolvimento

O ambiente de desenvolvimento inclui:

- **PostgreSQL**: Banco de dados principal
- **Redis**: Cache distribu√≠do
- **Kafka + Zookeeper**: Mensageria ass√≠ncrona
- **Azurite**: Mock do Azure Blob Storage
- **Kafka UI**: Interface web para monitoramento do Kafka

## üöÄ Setup R√°pido

### 1. Pr√©-requisitos

- Docker e Docker Compose instalados
- Java 21
- Maven 3.8+

### 2. Configura√ß√£o Inicial

```bash
# Clone o reposit√≥rio (se necess√°rio)
git clone <repository-url>
cd videos-api

# Configure o ambiente
./scripts/dev-setup.sh
```

### 3. Executar a Aplica√ß√£o

**Op√ß√£o 1: Via IDE (Recomendado para desenvolvimento)**
```bash
# Configure a vari√°vel de ambiente
export SPRING_PROFILES_ACTIVE=local

# Execute a classe VideosApiApplication na sua IDE
```

**Op√ß√£o 2: Via Docker**
```bash
# Execute com todos os servi√ßos
docker-compose --profile full-stack up
```

### 4. Resolver Problemas de Compila√ß√£o Lombok

Se encontrar erros de compila√ß√£o relacionados ao Lombok, siga estes passos:

**Para IntelliJ IDEA:**
1. Instale o plugin Lombok: `File > Settings > Plugins > Lombok`
2. Habilite annotation processing: `File > Settings > Build > Compiler > Annotation Processors`
3. Marque "Enable annotation processing"
4. Rebuild o projeto: `Build > Rebuild Project`

**Para Eclipse:**
1. Baixe lombok.jar do site oficial
2. Execute: `java -jar lombok.jar`
3. Aponte para a instala√ß√£o do Eclipse
4. Reinicie o Eclipse

**Via Maven (alternativa):**
```bash
mvn clean compile -Dmaven.compiler.annotationProcessorPaths=org.projectlombok:lombok:1.18.30
```

## üîß Configura√ß√£o Detalhada

### Profiles de Aplica√ß√£o

- **`local`**: Desenvolvimento local com mocks habilitados
- **`dev`**: Desenvolvimento com servi√ßos reais
- **`prod`**: Produ√ß√£o

### Vari√°veis de Ambiente

```bash
# Configura√ß√µes do banco de dados
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=techchallenge

# Configura√ß√µes Redis
SPRING_REDIS_HOST=localhost
SPRING_REDIS_PORT=6379

# Configura√ß√µes Kafka
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_TOPIC_VIDEO_UPLOAD=video-upload-events
KAFKA_TOPIC_VIDEO_STATUS_UPDATE=video-status-update-events
KAFKA_CONSUMER_GROUP_ID=video-api-consumer-group

# Azure Storage (Mock)
AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://localhost:10000/devstoreaccount1;
AZURE_STORAGE_CONTAINER_NAME=videos
```

## üéØ Testando os Endpoints

### 1. Upload de V√≠deo

```bash
curl -X POST http://localhost:8080/api/v1/videos/upload \
  -F "file=@/path/to/video.mp4" \
  -H "Content-Type: multipart/form-data"
```

### 2. Listar Todos os V√≠deos

```bash
curl -X GET http://localhost:8080/api/v1/videos
```

### 3. Listar V√≠deos por Status

```bash
# Status dispon√≠veis: UPLOADED, PROCESSING, PROCESSED, FAILED
curl -X GET http://localhost:8080/api/v1/videos/status/UPLOADED
```

### 4. Consultar V√≠deo Espec√≠fico

```bash
curl -X GET http://localhost:8080/api/v1/videos/1
```

### 5. Simular Atualiza√ß√£o de Status via Kafka

Para testar o consumer, voc√™ pode publicar uma mensagem no t√≥pico Kafka:

```bash
# Acesse o Kafka UI em http://localhost:8081
# Ou use o kafka-console-producer:

docker exec -it videos_kafka kafka-console-producer \
  --bootstrap-server localhost:29092 \
  --topic video-status-update-events

# Envie uma mensagem JSON:
{
  "videoId": 1,
  "previousStatus": "UPLOADED",
  "newStatus": "PROCESSING",
  "message": "Video processing started",
  "processedBy": "video-processor-service",
  "timestamp": "2025-09-06T10:44:00"
}
```

## üîç Monitoramento e Debug

### Acessar Servi√ßos

- **Aplica√ß√£o**: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **Kafka UI**: http://localhost:8081
- **Health Check**: http://localhost:8080/actuator/health

### Logs Importantes

```bash
# Logs da aplica√ß√£o
docker-compose logs app

# Logs do Kafka
docker-compose logs kafka

# Logs do PostgreSQL
docker-compose logs postgres

# Logs do Redis
docker-compose logs redis
```

### Verificar Cache Redis

```bash
# Conectar ao Redis
docker exec -it videos_redis redis-cli

# Verificar chaves de cache
KEYS video:*
KEYS videos:*

# Ver status de um v√≠deo espec√≠fico
GET video:status:1
```

## üîÑ Fluxo Completo de Teste

### 1. Teste de Upload e Processamento

```bash
# 1. Fazer upload de um v√≠deo
curl -X POST http://localhost:8080/api/v1/videos/upload \
  -F "file=@test-video.mp4"

# 2. Verificar se foi salvo
curl -X GET http://localhost:8080/api/v1/videos

# 3. Simular mudan√ßa de status para PROCESSING
# (via Kafka UI ou console producer)

# 4. Verificar atualiza√ß√£o
curl -X GET http://localhost:8080/api/v1/videos/1

# 5. Simular conclus√£o do processamento
# Enviar status PROCESSED via Kafka

# 6. Verificar link de download dispon√≠vel
curl -X GET http://localhost:8080/api/v1/videos/1
```

## üõ†Ô∏è Scripts de Gerenciamento

### Iniciar Ambiente

```bash
./scripts/dev-setup.sh
```

### Parar Servi√ßos

```bash
./scripts/dev-stop.sh
```

### Limpar Ambiente (Remove volumes)

```bash
./scripts/dev-clean.sh
```

## üêõ Troubleshooting

### Problema: Servi√ßos n√£o iniciam

```bash
# Verificar se as portas est√£o livres
lsof -i :5432  # PostgreSQL
lsof -i :6379  # Redis
lsof -i :9092  # Kafka

# Limpar containers antigos
docker-compose down -v
docker system prune -f
```

### Problema: Kafka n√£o conecta

```bash
# Verificar health do Kafka
docker-compose ps

# Verificar logs
docker-compose logs kafka

# Recriar apenas o Kafka
docker-compose up -d --force-recreate kafka
```

### Problema: Cache Redis n√£o funciona

```bash
# Verificar conex√£o Redis
docker exec -it videos_redis redis-cli ping

# Verificar configura√ß√£o da aplica√ß√£o
curl http://localhost:8080/actuator/health
```

## üìã Servi√ßos Dispon√≠veis

| Servi√ßo | URL/Porta | Descri√ß√£o |
|---------|-----------|-----------|
| API Principal | http://localhost:8080 | Aplica√ß√£o Spring Boot |
| Swagger UI | http://localhost:8080/swagger-ui.html | Documenta√ß√£o interativa da API |
| Health Check | http://localhost:8080/actuator/health | Status da aplica√ß√£o |
| PostgreSQL | localhost:5432 | Banco de dados principal |
| Redis | localhost:6379 | Cache distribu√≠do |
| Kafka | localhost:9092 | Message broker |
| Kafka UI | http://localhost:8081 | Interface web do Kafka |
| Azurite | localhost:10000-10002 | Mock Azure Blob Storage |

## üîÑ T√≥picos Kafka

| T√≥pico | Descri√ß√£o | Uso |
|--------|-----------|-----|
| `video-upload-events` | Eventos de upload de v√≠deo | Publicado ap√≥s upload bem-sucedido |
| `video-status-update-events` | Atualiza√ß√µes de status | Consumido para atualizar status no banco |

## üìä Estrutura do Cache Redis

```
video:{id}              # Objeto completo do v√≠deo (TTL: 10min)
video:status:{id}       # Status do v√≠deo (TTL: 10min)
videos:all              # Lista de todos os v√≠deos (TTL: 10min)
videos:status_{status}  # Lista filtrada por status (TTL: 10min)
```

## üß™ Dados de Teste

### Exemplo de Payload para Status Update

```json
{
  "videoId": 1,
  "previousStatus": "UPLOADED",
  "newStatus": "PROCESSING",
  "message": "Video processing started by external service",
  "processedBy": "video-processor-v1.0",
  "timestamp": "2025-09-06T10:44:00"
}
```

### Formatos de V√≠deo Suportados

- MP4, AVI, MOV, WMV, FLV, WebM, MKV
- Tamanho m√°ximo: 500MB
- Valida√ß√£o via Apache Tika

## üöÄ Pr√≥ximos Passos

1. **Resolver Compila√ß√£o Lombok**: Configure annotation processing na IDE
2. **Testar Upload**: Use um arquivo de v√≠deo pequeno para teste
3. **Verificar Consumer**: Publique mensagem no Kafka e verifique atualiza√ß√£o
4. **Monitorar Cache**: Use Redis CLI para verificar chaves criadas
5. **Validar Fluxo Completo**: Teste todo o ciclo de upload ‚Üí processamento ‚Üí consulta

## üìù Notas Importantes

- O perfil `local` usa mocks para Azure Storage e Kafka (via Redis)
- Logs detalhados est√£o habilitados para debug
- Health checks garantem que servi√ßos estejam prontos antes da aplica√ß√£o iniciar
- Migrations do Flyway s√£o executadas automaticamente na inicializa√ß√£o

## üß™ Mocks e Simula√ß√µes

### Azure Blob Storage Mock

O Azurite simula o Azure Blob Storage localmente:

```bash
# Verificar containers
curl http://localhost:10000/devstoreaccount1?comp=list

# Arquivos s√£o armazenados em: /tmp/mock-azure-storage/
```

### Kafka Mock (Redis)

No perfil `local`, eventos Kafka s√£o simulados via Redis:

```bash
# Verificar eventos no Redis
docker exec -it videos_redis redis-cli
KEYS *events*
```

## üîß Configura√ß√£o da IDE

### IntelliJ IDEA

1. **Importar Projeto**: `File > Open` ‚Üí selecione o `pom.xml`
2. **Configurar JDK**: `File > Project Structure > Project > SDK` ‚Üí Java 21
3. **Habilitar Lombok**: 
   - `File > Settings > Plugins` ‚Üí instalar Lombok Plugin
   - `File > Settings > Build > Compiler > Annotation Processors` ‚Üí Enable annotation processing
4. **Configurar Run Configuration**:
   - Main class: `br.com.fiap.videosapi.VideosApiApplication`
   - Environment variables: `SPRING_PROFILES_ACTIVE=local`

### VS Code

1. **Extens√µes necess√°rias**:
   - Extension Pack for Java
   - Spring Boot Extension Pack
   - Lombok Annotations Support

2. **Configurar settings.json**:
```json
{
  "java.configuration.updateBuildConfiguration": "automatic",
  "java.compile.nullAnalysis.mode": "automatic",
  "spring-boot.ls.problem.application-properties.enabled": true
}
```

## üìà Monitoramento de Performance

### M√©tricas Dispon√≠veis

```bash
# Actuator endpoints
curl http://localhost:8080/actuator/metrics
curl http://localhost:8080/actuator/health/redis
curl http://localhost:8080/actuator/health/db
```

### Cache Hit Rate

```bash
# Verificar estat√≠sticas do Redis
docker exec -it videos_redis redis-cli info stats
```

## üîí Seguran√ßa em Desenvolvimento

- Credenciais padr√£o apenas para desenvolvimento local
- Azure Storage usa chaves de desenvolvimento do Azurite
- Kafka sem autentica√ß√£o (apenas desenvolvimento)
- PostgreSQL com usu√°rio/senha padr√£o

**‚ö†Ô∏è NUNCA use essas configura√ß√µes em produ√ß√£o!**

O `MockAzureBlobStorageService` simula o Azure Blob Storage:

- **Habilitado quando**: `azure.storage.mock.enabled=true`
- **Armazenamento**: Arquivos salvos em `/tmp/mock-azure-storage/`
- **URLs**: Retorna URLs mock no formato `http://localhost:8080/mock-storage/{filename}`

### Kafka Mock

O `MockVideoEventProducer` simula o Kafka usando Redis:

- **Habilitado quando**: `kafka.mock.enabled=true`
- **Armazenamento**: Eventos salvos no Redis com TTL de 1 hora
- **Chaves**: `mock:video-upload-events:{videoId}`

### Cache Redis

Configurado para cache de dados com TTL de 10 minutos:

```yaml
spring:
  cache:
    type: redis
    redis:
      time-to-live: 600000  # 10 minutos
```

## üìù Scripts Utilit√°rios

### Gerenciamento do Ambiente

```bash
# Iniciar ambiente de desenvolvimento
./scripts/dev-setup.sh

# Parar servi√ßos
./scripts/dev-stop.sh

# Limpar completamente (remove volumes)
./scripts/dev-clean.sh
```

### Comandos Docker √öteis

```bash
# Ver logs de um servi√ßo espec√≠fico
docker-compose logs -f kafka

# Executar apenas servi√ßos de infraestrutura
docker-compose up -d postgres redis kafka zookeeper azurite

# Rebuild da aplica√ß√£o
docker-compose build app

# Ver status dos servi√ßos
docker-compose ps
```

## üîç Monitoramento e Debug

### Logs da Aplica√ß√£o

```bash
# Logs em tempo real
docker-compose logs -f app

# Logs do Kafka
docker-compose logs -f kafka
```

### Kafka UI

Acesse `http://localhost:8081` para:
- Visualizar t√≥picos
- Monitorar mensagens
- Gerenciar consumers

### Redis CLI

```bash
# Conectar ao Redis
docker exec -it videos_redis redis-cli

# Ver eventos mock do Kafka
LRANGE mock:video-upload-events:list 0 -1
```

## üß™ Testes

### Testes de Integra√ß√£o

```bash
# Executar testes com Testcontainers
mvn test -Dspring.profiles.active=test
```

### Teste Manual da API

```bash
# Health check
curl http://localhost:8080/actuator/health

# Upload de v√≠deo (exemplo)
curl -X POST http://localhost:8080/api/videos/upload \
  -F "file=@test-video.mp4" \
  -H "Content-Type: multipart/form-data"
```

## üîß Troubleshooting

### Problemas Comuns

**Erro de conex√£o com PostgreSQL**
```bash
# Verificar se o container est√° rodando
docker-compose ps postgres

# Ver logs
docker-compose logs postgres
```

**Erro de conex√£o com Redis**
```bash
# Testar conex√£o
docker exec videos_redis redis-cli ping
```

**Kafka n√£o est√° funcionando**
```bash
# Verificar Zookeeper primeiro
docker-compose logs zookeeper

# Depois o Kafka
docker-compose logs kafka
```

### Reset Completo

```bash
# Parar tudo e limpar volumes
./scripts/dev-clean.sh

# Recriar ambiente
./scripts/dev-setup.sh
```

## üìö Estrutura do Projeto

```
src/main/java/br/com/fiap/videosapi/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ       ‚îú‚îÄ‚îÄ RedisConfig.java          # Configura√ß√£o do Redis
‚îÇ       ‚îî‚îÄ‚îÄ DevelopmentConfig.java    # Beans para desenvolvimento
‚îú‚îÄ‚îÄ video/
‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îú‚îÄ‚îÄ azure/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ AzureBlobStorageService.java
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ MockAzureBlobStorageService.java
‚îÇ       ‚îî‚îÄ‚îÄ kafka/
‚îÇ           ‚îú‚îÄ‚îÄ VideoEventProducer.java
‚îÇ           ‚îú‚îÄ‚îÄ MockVideoEventProducer.java
‚îÇ           ‚îî‚îÄ‚îÄ VideoEventPublisher.java
```

## üöÄ Pr√≥ximos Passos

1. **Cache Strategy**: Implementar cache em endpoints cr√≠ticos
2. **Monitoring**: Adicionar Prometheus/Grafana
3. **Tracing**: Implementar distributed tracing
4. **Security**: Configurar autentica√ß√£o/autoriza√ß√£o

---

Para d√∫vidas ou sugest√µes, consulte a documenta√ß√£o da API em `http://localhost:8080/swagger-ui.html` quando a aplica√ß√£o estiver rodando.
